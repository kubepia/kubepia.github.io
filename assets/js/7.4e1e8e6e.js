(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{553:function(t,s,a){t.exports=a.p+"assets/img/2020-07-03-08-37-15.f074a2b3.png"},554:function(t,s,a){t.exports=a.p+"assets/img/2020-07-03-08-55-51.ad855d53.png"},555:function(t,s,a){t.exports=a.p+"assets/img/2020-07-03-08-42-19.93720667.png"},556:function(t,s,a){t.exports=a.p+"assets/img/2020-05-31-14-22-26.0c5f5ee6.png"},557:function(t,s,a){t.exports=a.p+"assets/img/2020-05-31-14-22-41.da27fbcd.png"},558:function(t,s,a){t.exports=a.p+"assets/img/2020-05-31-14-24-59.63cd280d.png"},559:function(t,s,a){t.exports=a.p+"assets/img/2020-05-31-14-29-38.4ab02910.png"},560:function(t,s,a){t.exports=a.p+"assets/img/2020-05-31-14-33-29.8231fa73.png"},561:function(t,s,a){t.exports=a.p+"assets/img/2020-05-31-14-36-32.ef13b717.png"},562:function(t,s,a){t.exports=a.p+"assets/img/2020-05-31-14-52-25.2027d6ba.png"},563:function(t,s,a){t.exports=a.p+"assets/img/2020-05-31-14-39-16.0121b6b0.png"},564:function(t,s,a){t.exports=a.p+"assets/img/2020-05-31-15-47-13.c3671809.png"},565:function(t,s,a){t.exports=a.p+"assets/img/2020-05-31-15-47-59.9f751959.png"},566:function(t,s,a){t.exports=a.p+"assets/img/2020-07-07-22-52-33.5a6e6613.png"},567:function(t,s,a){t.exports=a.p+"assets/img/2020-07-07-22-55-55.7a81be54.png"},616:function(t,s,a){"use strict";a.r(s);var e=a(25),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"ocp-idp-추가"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ocp-idp-추가"}},[t._v("#")]),t._v(" OCP-IdP 추가")]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TASK DESCRIPTION")]),t._v(" "),e("p",[t._v("계정제공자(IdP-Identity Provider)를 추가합니다"),e("br"),t._v("\n본 매뉴얼에서는 htpasswd와 keycloak을 설명합니다.")]),t._v(" "),e("p"),e("div",{staticClass:"table-of-contents"},[e("ul",[e("li",[e("a",{attrs:{href:"#htpasswd-추가"}},[t._v("htpasswd 추가")])]),e("li",[e("a",{attrs:{href:"#ldap-추가"}},[t._v("ldap 추가")])]),e("li",[e("a",{attrs:{href:"#keycloak-추가"}},[t._v("keycloak 추가")]),e("ul",[e("li",[e("a",{attrs:{href:"#keycloak-설치"}},[t._v("keycloak 설치")])]),e("li",[e("a",{attrs:{href:"#key-cloak-설정-realm-client-작성"}},[t._v("key cloak 설정: realm, client 작성")])]),e("li",[e("a",{attrs:{href:"#ocp의-idp로-keycloak-등록"}},[t._v("OCP의 IdP로 keycloak 등록")])])])]),e("li",[e("a",{attrs:{href:"#user-idp-변경"}},[t._v("User IdP 변경")])])])]),e("p")]),t._v(" "),e("h2",{attrs:{id:"htpasswd-추가"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#htpasswd-추가"}},[t._v("#")]),t._v(" htpasswd 추가")]),t._v(" "),e("p",[t._v("htpasswd는 OCP자체적으로 계정을 추가할 수 있는 방법입니다.")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("계정 등록 파일 생성")])])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("$ yum install -y httpd-tools  \n$ which htpasswd  \n$ htpasswd -c -B -b <파일명> <user_name> <password>  \n계정 추가시에는 -c옵션 주면 안됨   \n예) \n[root@bastion idp]# htpasswd -c -B -b users.htpasswd hklee passw0rd \\\nAdding password for user hklee \\\n[root@bastion idp]# htpasswd -B -b users.htpasswd sihan passw0rd \\\nAdding password for user sihan \\\n[root@bastion idp]# htpasswd -B -b users.htpasswd shlee passw0rd \\\nAdding password for user shlee \\\n[root@bastion idp]# cat users.htpasswd \\\nhklee:$2y$05$1ZSl07frbmRvwY2Uxuz.Cu38bTh.UMR8wAD1/i5YTOuym0yhX8F4S \\\nsihan:$2y$05$VF9BcY4pSPTy7uParHwZt.Qaf5agVto5EduZXmuPGwFxOyqdNRPqu \\\nshlee:$2y$05$Lx9qrVCFnC1weCMkOkj/jOA6kOkM49CjhnQrOOVFHmyrwhHz0b2Ta \\\n")])])]),e("ul",[e("li",[e("p",[e("strong",[t._v("IdP추가")])]),t._v(" "),e("ul",[e("li",[t._v("OCP webconsole로그인: 최초에는 kubeadmin으로 로그인")]),t._v(" "),e("li",[t._v("Administration->Cluster-Settings클릭")]),t._v(" "),e("li",[t._v("Global configuration탭 클릭하고 oAuth 클릭")]),t._v(" "),e("li",[t._v("IdP추가: htpasswd 선택하고 위에서 생성한 파일 지정")])])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("rolebinding")]),e("br"),t._v("\n추가한 user에게 권한을 binding 합니다.")]),t._v(" "),e("ul",[e("li",[t._v("OCP web console > user management > Role bindings")]),t._v(" "),e("li",[t._v("create role binding")])])])]),t._v(" "),e("h2",{attrs:{id:"ldap-추가"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ldap-추가"}},[t._v("#")]),t._v(" ldap 추가")]),t._v(" "),e("p",[t._v("먼저 아래 링크 참조하여 LDAP서버 설치 및 구성합니다."),e("br"),t._v(" "),e("a",{attrs:{href:"https://kubepia.github.io/cloudpak/cp4app/install/cp4app01.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("LDAP서버 설치 및 구성"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("그리고 OCP Web console에서 IdP를 LDAP 타입으로 추가합니다.")]),t._v(" "),e("ul",[e("li",[t._v("Administration->Cluster-Settings클릭")]),t._v(" "),e("li",[t._v("Global configuration탭 클릭하고 oAuth 클릭")]),t._v(" "),e("li",[t._v("IdP추가: LDAP 선택")])]),t._v(" "),e("p",[t._v("아래 화면을 참조하여 값을 지정합니다. 특히 url, attributes > id을 정확하게 지정하십시오."),e("br"),t._v("\nurl이 맞는지 확인하려면 'curl [url]'명령을 이용하십시오."),e("br"),t._v(" "),e("img",{attrs:{src:a(553),alt:""}})]),t._v(" "),e("p",[t._v("등록 후 YAML에서 'insecure'를 'true'로 변경하십시오.")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("apiVersion: config.openshift.io/v1\nkind: OAuth\nmetadata:\n  annotations:\n    release.openshift.io/create-only: 'true'\n  creationTimestamp: '2020-07-02T04:17:40Z'\n  generation: 26\n  name: cluster\n  resourceVersion: '129232'\n  selfLink: /apis/config.openshift.io/v1/oauths/cluster\n  uid: 2c5c1e08-a2b8-4684-9282-83fb5f9fa528\nspec:\n  identityProviders:\n    - htpasswd:\n        fileData:\n          name: htpasswd-cw55j\n      mappingMethod: claim\n      name: ADMINS\n      type: HTPasswd\n    - ldap:\n        attributes:\n          email: []\n          id:\n            - uid\n          name:\n            - cn\n          preferredUsername:\n            - uid\n        bindDN: 'cn=admin,dc=ldap,dc=kubepia,dc=com'\n        bindPassword:\n          name: ldap-bind-password-b5j5j\n        insecure: true\n        url: 'ldap://ldap.kubepia.com:389/ou=users,dc=ldap,dc=kubepia,dc=com?uid'\n      mappingMethod: claim\n      name: ldap\n      type: LDAP\n")])])]),e("p",[t._v("저장 후 namespace 'openshift-authentication'의 Pod 2개가 재생성될때까지 기다립니다.")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[root@ocp-infra1 ~]# oc get po -n openshift-authentication\nNAME                               READY   STATUS    RESTARTS   AGE\noauth-openshift-5cff94bdcd-5kqcx   1/1     Running   0          14h\noauth-openshift-5cff94bdcd-gcvlr   1/1     Running   0          14h\n")])])]),e("p",[t._v("user에 권한 부여를 위해 role binding을 합니다.")]),t._v(" "),e("ul",[e("li",[t._v("OCP web console > user management > Role bindings")]),t._v(" "),e("li",[t._v("create role binding"),e("br"),t._v("\n아래는 cluster-admin 권한을 부여하는 role binding 예제입니다."),e("br"),t._v(" "),e("img",{attrs:{src:a(554),alt:""}})])]),t._v(" "),e("p",[t._v("로그아웃 후 LDAP으로 로그인하는 버튼이 나올때까지 기다립니다."),e("br"),t._v("\n추가한 user로 로그인 테스트합니다."),e("br"),t._v(" "),e("img",{attrs:{src:a(555),alt:""}})]),t._v(" "),e("h2",{attrs:{id:"keycloak-추가"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#keycloak-추가"}},[t._v("#")]),t._v(" keycloak 추가")]),t._v(" "),e("h3",{attrs:{id:"keycloak-설치"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#keycloak-설치"}},[t._v("#")]),t._v(" keycloak 설치")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("작업디렉토리 생성")]),e("br"),t._v("\ncluster접근할 수 있는 Terminal에서 작업(예: bastion VM에서 작업)")])]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p ~/tmp/keycloak\n$ "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" ~/tmp/keycloak \n")])])]),e("ul",[e("li",[e("strong",[t._v("namespace 생성")])])]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("$ oc new-project keycloak\n$ oc adm policy add-scc-to-user anyuid -z default \n$ oc project keycloak\n")])])]),e("ul",[e("li",[e("strong",[t._v("helm repository 추가")])])]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("$ helm repo "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" codecentric https://codecentric.github.io/helm-charts\n$ helm search repo keycloak\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@bastion ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm search repo keycloak")]),t._v("\nNAME                \tCHART VERSION\tAPP VERSION\tDESCRIPTION\ncodecentric/keycloak\t"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.2")]),t._v(".2        \t"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".0     \tOpen Source Identity and Access Management For "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nstable/keycloak     \t"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.10")]),t._v(".1       \t"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),t._v(".0      \tDEPRECATED - Open Source Identity and Access Ma\n")])])]),e("ul",[e("li",[e("strong",[t._v("helm으로 keycloak설치")])])]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("$ helm inspect values codecentric/keycloak "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" config.yaml\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" config.yaml\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## Username for the initial Keycloak admin user")]),t._v("\n  username: keycloak\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## Password for the initial Keycloak admin user. Applicable only if existingSecret is not set.")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## If not set, a random 10 characters password will be used")]),t._v("\n  password: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"passw0rd"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## OpenShift route configuration.")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## ref: https://docs.openshift.com/container-platform/3.11/architecture/networking/routes.html")]),t._v("\n  route:\n    enabled: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n    path: /\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## Persistence configuration")]),t._v("\n  persistence:\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# If true, the Postgres chart is deployed")]),t._v("\n    deployPostgres: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# The database vendor. Can be either "postgres", "mysql", "mariadb", or "h2"')]),t._v("\n    dbVendor: postgres\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\npostgresql:\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("### PostgreSQL User to create.")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("##")]),t._v("\n  postgresqlUsername: keycloak\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## PostgreSQL Password for the new user.")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## If not set, a random 10 characters password will be used.")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("##")]),t._v("\n  postgresqlPassword: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"passw0rd"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## Persistent Volume Storage configuration.")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## ref: https://kubernetes.io/docs/user-guide/persistent-volumes")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("##")]),t._v("\n  persistence:\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## Enable PostgreSQL persistence using Persistent Volume Claims.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("##")]),t._v("\n    enabled: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n\n$ helm "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" keycloak -f config.yaml codecentric/keycloak -n keycloak\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("watch")]),t._v(" oc get po\nEvery "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".0s: oc get po                                                                                                                                Sun May "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("31")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v(":17:18 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v("\n\nNAME                    READY   STATUS              RESTARTS   AGE\nkeycloak-0              "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Init:0/1            "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          12s\nkeycloak-postgresql-0   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     ContainerCreating   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          12s\n\n")])])]),e("ul",[e("li",[e("strong",[t._v("keycloak 로그인")])])]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("$ oc get route \n\n")])])]),e("p",[t._v("웹브라우저에서 위 주소로 접근합니다."),e("br"),t._v("\nconfig.yaml에서 지정한 id와 pw로 로그인합니다.")]),t._v(" "),e("p",[e("img",{attrs:{src:a(556),alt:""}})]),t._v(" "),e("p",[e("img",{attrs:{src:a(557),alt:""}})]),t._v(" "),e("h3",{attrs:{id:"key-cloak-설정-realm-client-작성"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#key-cloak-설정-realm-client-작성"}},[t._v("#")]),t._v(" "),e("strong",[t._v("key cloak 설정: realm, client 작성")])]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("realm 작성")]),e("br"),t._v("\nrealm은 인증대상범위를 의미합니다.")])]),t._v(" "),e("p",[e("img",{attrs:{src:a(558),alt:""}}),t._v(" "),e("img",{attrs:{src:a(559),alt:""}})]),t._v(" "),e("p",[t._v("issuer주소를 clipboard에 복사해 놓습니다."),e("br"),t._v(" "),e("img",{attrs:{src:a(560),alt:""}}),t._v(" "),e("img",{attrs:{src:a(561),alt:""}})]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("예) https://keycloak-keycloak.apps.cp.kubepia.com/auth/realms/kubepia\n")])])]),e("p",[t._v("public key값을 Local PC에 파일로 생성합니다.\n"),e("img",{attrs:{src:a(562),alt:""}})]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("public key Sample\n\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAnXVty1Q9jiObqJYPPAGLMiPhm8a+nVncMWoL9KVO4pZPkA6PQsYcMzq+YQyHQy442p+l8d2si5ZcNgLnnfH7WtiysMxRVUHKeNtGAetSwZIb2r/WLapiEoBoXSBZ4hREWaYfZqJAzrxgpRGsl8J5MmYj0HLoXQdY6H3CuPN+770EAA411Xvr31Z9MloC4/XKO+ZxqXUk5N8cCSWvPt1hyWpG32/fqgglcKUCdbJ1P4ieYT9y8NkBzHG9+CfGJUr7Sh7goSTKiO0gAoP/b32lmTGWnmV91JcYOmGQXbkBBA8kfB0l6C+TG574sIwmChemhNeMjU6SKCvM56RqvNR7rQIDAQAB\n")])])]),e("ul",[e("li",[e("strong",[t._v("Client 작성")])])]),t._v(" "),e("p",[t._v("Client는 keycloak으로 인증을 요청하는 소스 어플리케이션입니다.")]),t._v(" "),e("p",[e("img",{attrs:{src:a(563),alt:""}}),t._v(" "),e("img",{attrs:{src:a(564),alt:""}})]),t._v(" "),e("p",[t._v("Credential값을 clipboard에 복사합니다."),e("br"),t._v(" "),e("img",{attrs:{src:a(565),alt:""}})]),t._v(" "),e("h3",{attrs:{id:"ocp의-idp로-keycloak-등록"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ocp의-idp로-keycloak-등록"}},[t._v("#")]),t._v(" OCP의 IdP로 keycloak 등록")]),t._v(" "),e("p",[t._v("등록방법 찾는중입니다.")]),t._v(" "),e("h2",{attrs:{id:"user-idp-변경"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#user-idp-변경"}},[t._v("#")]),t._v(" User IdP 변경")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("User identities정보 삭제")])])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("$ oc get User\n$ oc edit User hklee\n")])])]),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}},[t._v("As-Is")]),t._v(" "),e("th",{staticStyle:{"text-align":"left"}},[t._v("To-Be")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("img",{attrs:{src:a(566),alt:""}})]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("img",{attrs:{src:a(567),alt:""}})])])])]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("identities 리소스 삭제")])])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("$ oc get identities\n$ oc delete identities admin:hklee\n")])])]),e("hr"),t._v(" "),e("disqus")],1)}),[],!1,null,null,null);s.default=n.exports}}]);