<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OCP-NFS Dynamic provisioning | Kubepia Documents</title>
    <meta name="description" content="Technical guidelines about kubernetes">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicons/site.webmanifest">
    
    <link rel="preload" href="/assets/css/0.styles.6963f482.css" as="style"><link rel="preload" href="/assets/js/app.a454bc5d.js" as="script"><link rel="preload" href="/assets/js/2.d0268367.js" as="script"><link rel="preload" href="/assets/js/20.af0b04b8.js" as="script"><link rel="preload" href="/assets/js/23.ff512bf7.js" as="script"><link rel="prefetch" href="/assets/js/10.2cd97a1e.js"><link rel="prefetch" href="/assets/js/11.90d28864.js"><link rel="prefetch" href="/assets/js/12.647d1099.js"><link rel="prefetch" href="/assets/js/13.a9dcc1a0.js"><link rel="prefetch" href="/assets/js/14.b58cad56.js"><link rel="prefetch" href="/assets/js/15.5068421a.js"><link rel="prefetch" href="/assets/js/16.f697a0e4.js"><link rel="prefetch" href="/assets/js/17.106a8d76.js"><link rel="prefetch" href="/assets/js/18.ba551221.js"><link rel="prefetch" href="/assets/js/19.22af9183.js"><link rel="prefetch" href="/assets/js/21.5004ad51.js"><link rel="prefetch" href="/assets/js/22.1b141f98.js"><link rel="prefetch" href="/assets/js/24.6eed070e.js"><link rel="prefetch" href="/assets/js/25.50646342.js"><link rel="prefetch" href="/assets/js/26.3a97915e.js"><link rel="prefetch" href="/assets/js/27.cf6b59af.js"><link rel="prefetch" href="/assets/js/28.e9c10a2b.js"><link rel="prefetch" href="/assets/js/29.1486e207.js"><link rel="prefetch" href="/assets/js/3.cf8c0ae1.js"><link rel="prefetch" href="/assets/js/30.1ffbe203.js"><link rel="prefetch" href="/assets/js/31.ebf31149.js"><link rel="prefetch" href="/assets/js/32.ee5997da.js"><link rel="prefetch" href="/assets/js/33.adf63ac0.js"><link rel="prefetch" href="/assets/js/34.7aa45f0e.js"><link rel="prefetch" href="/assets/js/35.16ebfd35.js"><link rel="prefetch" href="/assets/js/36.37076d52.js"><link rel="prefetch" href="/assets/js/37.000341f8.js"><link rel="prefetch" href="/assets/js/38.35e531a9.js"><link rel="prefetch" href="/assets/js/39.cafdafc5.js"><link rel="prefetch" href="/assets/js/4.66de6556.js"><link rel="prefetch" href="/assets/js/40.ace4d15a.js"><link rel="prefetch" href="/assets/js/41.3c407481.js"><link rel="prefetch" href="/assets/js/5.455ef8a4.js"><link rel="prefetch" href="/assets/js/6.eb1fcde4.js"><link rel="prefetch" href="/assets/js/7.7b466e64.js"><link rel="prefetch" href="/assets/js/8.56053b4e.js"><link rel="prefetch" href="/assets/js/9.94a83401.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6963f482.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/kubepia.png" alt="Kubepia Documents" class="logo"> <span class="site-name can-hide">Kubepia Documents</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/devops/overview.html" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">
  K8S
</a></div><div class="nav-item"><a href="/ocp/overview.html" class="nav-link">
  OCP4.X
</a></div><div class="nav-item"><a href="/cloudpak/overview.html" class="nav-link">
  CloudPak
</a></div><div class="nav-item"><a href="/architecture/" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="/aboutus/iamnogada.html" class="nav-link">
  About US
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/devops/overview.html" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">
  K8S
</a></div><div class="nav-item"><a href="/ocp/overview.html" class="nav-link">
  OCP4.X
</a></div><div class="nav-item"><a href="/cloudpak/overview.html" class="nav-link">
  CloudPak
</a></div><div class="nav-item"><a href="/architecture/" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="/aboutus/iamnogada.html" class="nav-link">
  About US
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>CloudPak</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cloudpak/cp4app/overview" class="sidebar-heading clickable open"><span>CP4App</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/cloudpak/cp4app/install/install" class="sidebar-heading clickable open"><span>Install</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/cloudpak/cp4app/install/infra01.html" class="sidebar-link">Infra Servers-VM 생성</a></li><li><a href="/cloudpak/cp4app/install/infra02.html" class="sidebar-link">Infra Servers-Web서버 설치</a></li><li><a href="/cloudpak/cp4app/install/infra03.html" class="sidebar-link">Infra Servers-VM Network 설정</a></li><li><a href="/cloudpak/cp4app/install/infra04.html" class="sidebar-link">Infra Servers-DNS서버 설치</a></li><li><a href="/cloudpak/cp4app/install/infra05.html" class="sidebar-link">Infra Servers-HAProxy서버 설치</a></li><li><a href="/cloudpak/cp4app/install/infra06.html" class="sidebar-link">Infra Servers-DHCP서버 설치</a></li><li><a href="/cloudpak/cp4app/install/infra07.html" class="sidebar-link">Infra Servers-NFS서버 설치</a></li><li><a href="/cloudpak/cp4app/install/infra08.html" class="sidebar-link">Infra Servers-SSLKey 구성</a></li><li><a href="/cloudpak/cp4app/install/infra09.html" class="sidebar-link">Infra Servers-iptables 설치</a></li><li><a href="/cloudpak/cp4app/install/ocp01.html" class="sidebar-link">OCP-ignition파일 및 VM생성</a></li><li><a href="/cloudpak/cp4app/install/ocp02.html" class="sidebar-link">OCP-OCP설치</a></li><li><a href="/cloudpak/cp4app/install/ocp03.html" class="sidebar-link">OCP-Local Image Registry 구성</a></li><li><a href="/cloudpak/cp4app/install/ocp04.html" class="active sidebar-link">OCP-NFS Dynamic provisioning</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cloudpak/cp4app/install/ocp04.html#git-설치" class="sidebar-link">git 설치</a></li><li class="sidebar-sub-header"><a href="/cloudpak/cp4app/install/ocp04.html#nfs-provisioner용-namespace-생성" class="sidebar-link">nfs provisioner용 namespace 생성</a></li><li class="sidebar-sub-header"><a href="/cloudpak/cp4app/install/ocp04.html#nfs-provisioner-다운로드" class="sidebar-link">nfs-provisioner 다운로드</a></li><li class="sidebar-sub-header"><a href="/cloudpak/cp4app/install/ocp04.html#service-account-생성-및-권한-설정" class="sidebar-link">Service Account 생성 및 권한 설정</a></li><li class="sidebar-sub-header"><a href="/cloudpak/cp4app/install/ocp04.html#storageclass-생성" class="sidebar-link">storageclass 생성</a></li><li class="sidebar-sub-header"><a href="/cloudpak/cp4app/install/ocp04.html#nfs-provisioner-pod-배포" class="sidebar-link">nfs-provisioner Pod 배포</a></li><li class="sidebar-sub-header"><a href="/cloudpak/cp4app/install/ocp04.html#테스트" class="sidebar-link">테스트</a></li></ul></li><li><a href="/cloudpak/cp4app/install/ocp05.html" class="sidebar-link">OCP-IdP 추가</a></li><li><a href="/cloudpak/cp4app/install/cp4app01.html" class="sidebar-link">CP4App-Common Service 설치</a></li><li><a href="/cloudpak/cp4app/install/cp4app02.html" class="sidebar-link">CP4App-CP4App 설치</a></li></ul></section></li></ul></section></li><li><a href="/cloudpak/cp4mm/overview.html" class="sidebar-link">CP4MM</a></li><li><a href="/cloudpak/md-sample.html" class="sidebar-link">Markdown sample</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ocp-nfs-dynamic-provisioning"><a href="#ocp-nfs-dynamic-provisioning" class="header-anchor">#</a> OCP-NFS Dynamic provisioning</h1> <div class="custom-block tip"><p class="custom-block-title">TASK DESCRIPTION</p> <p>PV Binding이 자동으로 되도록 NFS Dynamic provisioning 설정을 합니다.<br>
NFS dynamic provisioning을 하기 위한 nfs-provisioner Pod를 배포합니다.<br> <a href="https://github.com/kubernetes-incubator/external-storage" target="_blank" rel="noopener noreferrer">github의 external-storage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>를 참조하십시오.</p> <p></p><div class="table-of-contents"><ul><li><a href="#git-설치">git 설치</a></li><li><a href="#nfs-provisioner용-namespace-생성">nfs provisioner용 namespace 생성</a></li><li><a href="#nfs-provisioner-다운로드">nfs-provisioner 다운로드</a></li><li><a href="#service-account-생성-및-권한-설정">Service Account 생성 및 권한 설정</a></li><li><a href="#storageclass-생성">storageclass 생성</a></li><li><a href="#nfs-provisioner-pod-배포">nfs-provisioner Pod 배포</a></li><li><a href="#테스트">테스트</a></li></ul></div><p></p></div> <h2 id="git-설치"><a href="#git-설치" class="header-anchor">#</a> git 설치</h2> <div class="language- extra-class"><pre class="language-text"><code>$ yum install -y git 
</code></pre></div><h2 id="nfs-provisioner용-namespace-생성"><a href="#nfs-provisioner용-namespace-생성" class="header-anchor">#</a> nfs provisioner용 namespace 생성</h2> <div class="language- extra-class"><pre class="language-text"><code>$ oc new-project nfs
</code></pre></div><p><img src="/assets/img/2020-05-26-15-56-10.d0367d1f.png" alt=""></p> <h2 id="nfs-provisioner-다운로드"><a href="#nfs-provisioner-다운로드" class="header-anchor">#</a> nfs-provisioner 다운로드</h2> <div class="language- extra-class"><pre class="language-text"><code>$ mkdir -p /nfsprovider
$ cd /nfsprovider
$ git clone https://github.com/kubernetes-incubator/external-storage.git
$ cd external-storage/nfs-client/
</code></pre></div><h2 id="service-account-생성-및-권한-설정"><a href="#service-account-생성-및-권한-설정" class="header-anchor">#</a> Service Account 생성 및 권한 설정</h2> <div class="language- extra-class"><pre class="language-text"><code>현재 namespace를 nfs로 변경  
$ oc project nfs  

rbac.yaml내의 namespace를 모두 ‘nfs’로 변경하고 적용함    
$ NAMESPACE=`oc project -q`
$ sed -i'' &quot;s/namespace:.*/namespace: $NAMESPACE/g&quot; ./deploy/rbac.yaml  
$ oc apply -f deploy/rbac.yaml

service account 'nfs-client-provisioner'에게 hostmount-anyuid SCC적용  
$ oc adm policy add-scc-to-user hostmount-anyuid -z nfs-client-provisioner
</code></pre></div><p><strong>rbac.yaml</strong><br>
Service Account 'nfs-client-provisioner'을 만들고 필요한 role을 binding합니다.</p> <div class="language- extra-class"><pre class="language-text"><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: nfs-client-provisioner
  # replace with namespace where provisioner is deployed
  namespace: nfs
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: nfs-client-provisioner-runner
rules:
  - apiGroups: [&quot;&quot;]
    resources: [&quot;persistentvolumes&quot;]
    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]
  - apiGroups: [&quot;&quot;]
    resources: [&quot;persistentvolumeclaims&quot;]
    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;]
  - apiGroups: [&quot;storage.k8s.io&quot;]
    resources: [&quot;storageclasses&quot;]
    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]
  - apiGroups: [&quot;&quot;]
    resources: [&quot;events&quot;]
    verbs: [&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: run-nfs-client-provisioner
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    # replace with namespace where provisioner is deployed
    namespace: nfs
roleRef:
  kind: ClusterRole
  name: nfs-client-provisioner-runner
  apiGroup: rbac.authorization.k8s.io
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
  # replace with namespace where provisioner is deployed
  namespace: nfs
rules:
  - apiGroups: [&quot;&quot;]
    resources: [&quot;endpoints&quot;]
    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
  # replace with namespace where provisioner is deployed
  namespace: nfs
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    # replace with namespace where provisioner is deployed
    namespace: nfs
roleRef:
  kind: Role
  name: leader-locking-nfs-client-provisioner
  apiGroup: rbac.authorization.k8s.io
</code></pre></div><h2 id="storageclass-생성"><a href="#storageclass-생성" class="header-anchor">#</a> storageclass 생성</h2> <p><a href="https://kubepia.github.io/cloudpak/cp4app/install/ocp03.html" target="_blank" rel="noopener noreferrer">OCP Local Image Registry 구성<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>시 생성한 nfs-delete, nfs-retain외에 더 필요한 storage class가 있으면 생성합니다.</p> <div class="language- extra-class"><pre class="language-text"><code>storageclass YAML sample 

apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  #annotations:
    #storageclass.kubernetes.io/is-default-class: &quot;true&quot;
  name: nfs-standard
provisioner: kubernetes.io/no-provisioner
reclaimPolicy: Retain
volumeBindingMode: WaitForFirstConsumer
</code></pre></div><p>​</p> <h2 id="nfs-provisioner-pod-배포"><a href="#nfs-provisioner-pod-배포" class="header-anchor">#</a> nfs-provisioner Pod 배포</h2> <ul><li><strong>NFS서버 및 디렉토리 수정, namespace를 ‘nfs’로 변경</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ sed -i'' &quot;s/namespace:.*/namespace: $NAMESPACE/g&quot; ./deploy/deployment.yaml  
</code></pre></div><ul><li><strong>deployment.yaml수정</strong><br>
아래 항목을 적절하게 수정합니다.
<ul><li>env.PROVISIONER_NAME: storage class에 지정한 provisioner name과 동일하게 변경</li> <li>env.NFS_SERVER, volumes.nfs.server: nfs server의 IP</li> <li>env.NFS_PATH, volumes.nfs.path: nfs server에 미리 만든 자동으로 volume이 생성될 상위 디렉토리<br>
nfs_path디렉토리 하위에 자동으로 PVC별 디렉토리가 생성됩니다.</li></ul></li></ul> <blockquote><p><strong>중요</strong><br>
StorageClass생성 시 Provioner를 'kubernetes.io/no-provisioner'로 주면,<br>
Dynamic provisoning이 안됩니다.</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>SAMPLE

apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-client-provisioner
  labels:
    app: nfs-client-provisioner
  # replace with namespace where provisioner is deployed
  namespace: nfs
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: nfs-client-provisioner
  template:
    metadata:
      labels:
        app: nfs-client-provisioner
    spec:
      serviceAccountName: nfs-client-provisioner
      containers:
        - name: nfs-client-provisioner
          image: quay.io/external_storage/nfs-client-provisioner:latest
          volumeMounts:
            - name: nfs-client-root
              mountPath: /persistentvolumes
          env:
            - name: PROVISIONER_NAME
              value: standard
            - name: NFS_SERVER
              value: 10.40.89.158
            - name: NFS_PATH
              value: /nfs/data
      volumes:
        - name: nfs-client-root
          nfs:
            server: 10.40.89.158
            path: /nfs/data
</code></pre></div><ul><li><strong>Pod 생성</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ oc apply -f ./deploy/deployment.yaml ​
</code></pre></div><h2 id="테스트"><a href="#테스트" class="header-anchor">#</a> 테스트</h2> <ul><li><strong>테스트용 PVC생성</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ vi test-claim.yaml

apiVersion: &quot;v1&quot;
kind: &quot;PersistentVolumeClaim&quot;
metadata:
  name: &quot;test-claim&quot;
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: nfs-delete
  volumeMode: Filesystem

$ oc apply -f ./deploy/test-claim.yaml
$ oc get pvc
</code></pre></div><p><img src="/assets/img/2020-05-26-16-30-11.28c76a7f.png" alt=""></p> <ul><li><strong>테스트용 Pod생성</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ vi test-pod.yaml 

kind: Pod
apiVersion: v1
metadata:
  name: test-pod
spec:
  containers:
  - name: test-pod
    image: gcr.io/google_containers/busybox:1.24
    command:
      - &quot;/bin/sh&quot;
    args:
      - &quot;-c&quot;
      - &quot;touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1&quot;
    volumeMounts:
      - name: nfs-pvc
        mountPath: &quot;/mnt&quot;
  restartPolicy: &quot;Never&quot;
  volumes:
    - name: nfs-pvc
      persistentVolumeClaim:
        claimName: test-claim


$ oc apply -f test-pod.yaml
</code></pre></div><ul><li><strong>mount 확인</strong> <ul><li>nfs server의 nfs path로 이동</li> <li>pvc명으로 자동 생성된 디렉토리 확인</li> <li>디렉토리 하위에 SUCCESS파일 있는지 확인
​    <img src="/assets/img/2020-05-29-05-42-09.27d955fa.png" alt=""></li></ul></li></ul> <hr> <div id="disqus_thread"></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/cloudpak/cp4app/install/ocp03.html" class="prev">
        OCP-Local Image Registry 구성
      </a></span> <span class="next"><a href="/cloudpak/cp4app/install/ocp05.html">
        OCP-IdP 추가
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.a454bc5d.js" defer></script><script src="/assets/js/2.d0268367.js" defer></script><script src="/assets/js/20.af0b04b8.js" defer></script><script src="/assets/js/23.ff512bf7.js" defer></script>
  </body>
</html>
