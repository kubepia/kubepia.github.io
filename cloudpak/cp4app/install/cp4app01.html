<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CP4App-Common Service 설치 | Kubepia Documents</title>
    <meta name="description" content="Technical guidelines about kubernetes">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicons/site.webmanifest">
    
    <link rel="preload" href="/assets/css/0.styles.6963f482.css" as="style"><link rel="preload" href="/assets/js/app.3d45536c.js" as="script"><link rel="preload" href="/assets/js/2.3853ba78.js" as="script"><link rel="preload" href="/assets/js/3.8474c116.js" as="script"><link rel="preload" href="/assets/js/22.f96cd654.js" as="script"><link rel="prefetch" href="/assets/js/10.5d7b0b1e.js"><link rel="prefetch" href="/assets/js/11.20c7d947.js"><link rel="prefetch" href="/assets/js/12.e5188c33.js"><link rel="prefetch" href="/assets/js/13.e56033a2.js"><link rel="prefetch" href="/assets/js/14.54882cd9.js"><link rel="prefetch" href="/assets/js/15.81a58c83.js"><link rel="prefetch" href="/assets/js/16.c96b4ecf.js"><link rel="prefetch" href="/assets/js/17.56139d90.js"><link rel="prefetch" href="/assets/js/18.cc4f6ed3.js"><link rel="prefetch" href="/assets/js/19.321dac11.js"><link rel="prefetch" href="/assets/js/20.5fa2265d.js"><link rel="prefetch" href="/assets/js/21.9568b638.js"><link rel="prefetch" href="/assets/js/23.570c4718.js"><link rel="prefetch" href="/assets/js/24.e4a6baa7.js"><link rel="prefetch" href="/assets/js/25.f502c347.js"><link rel="prefetch" href="/assets/js/26.a68f0c26.js"><link rel="prefetch" href="/assets/js/27.2ca1abf4.js"><link rel="prefetch" href="/assets/js/28.118304ba.js"><link rel="prefetch" href="/assets/js/29.eaf2517d.js"><link rel="prefetch" href="/assets/js/30.bd060af5.js"><link rel="prefetch" href="/assets/js/31.45b21af9.js"><link rel="prefetch" href="/assets/js/32.20f2445a.js"><link rel="prefetch" href="/assets/js/33.960e702a.js"><link rel="prefetch" href="/assets/js/34.21737f9a.js"><link rel="prefetch" href="/assets/js/35.7cbdfda5.js"><link rel="prefetch" href="/assets/js/36.c75f6326.js"><link rel="prefetch" href="/assets/js/37.bfd6e82b.js"><link rel="prefetch" href="/assets/js/38.82f33a8a.js"><link rel="prefetch" href="/assets/js/39.fde7b480.js"><link rel="prefetch" href="/assets/js/4.10d35050.js"><link rel="prefetch" href="/assets/js/40.2147672d.js"><link rel="prefetch" href="/assets/js/41.3c407481.js"><link rel="prefetch" href="/assets/js/5.4bc52374.js"><link rel="prefetch" href="/assets/js/6.57e93076.js"><link rel="prefetch" href="/assets/js/7.2cfa6f93.js"><link rel="prefetch" href="/assets/js/8.6dfa3be8.js"><link rel="prefetch" href="/assets/js/9.2332f1e0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6963f482.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/kubepia.png" alt="Kubepia Documents" class="logo"> <span class="site-name can-hide">Kubepia Documents</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/devops/overview.html" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">
  K8S
</a></div><div class="nav-item"><a href="/ocp/overview.html" class="nav-link">
  OCP4.X
</a></div><div class="nav-item"><a href="/cloudpak/overview.html" class="nav-link">
  CloudPak
</a></div><div class="nav-item"><a href="/architecture/" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="/aboutus/iamnogada.html" class="nav-link">
  About US
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/devops/overview.html" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="/k8s/" class="nav-link">
  K8S
</a></div><div class="nav-item"><a href="/ocp/overview.html" class="nav-link">
  OCP4.X
</a></div><div class="nav-item"><a href="/cloudpak/overview.html" class="nav-link">
  CloudPak
</a></div><div class="nav-item"><a href="/architecture/" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="/aboutus/iamnogada.html" class="nav-link">
  About US
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>CloudPak</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cloudpak/cp4app/overview" class="sidebar-heading clickable open"><span>CP4App</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/cloudpak/cp4app/install/install" class="sidebar-heading clickable open"><span>Install</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/cloudpak/cp4app/install/infra01.html" class="sidebar-link">Infra Servers-VM 생성</a></li><li><a href="/cloudpak/cp4app/install/infra02.html" class="sidebar-link">Infra Servers-Web서버 설치</a></li><li><a href="/cloudpak/cp4app/install/infra03.html" class="sidebar-link">Infra Servers-VM Network 설정</a></li><li><a href="/cloudpak/cp4app/install/infra04.html" class="sidebar-link">Infra Servers-DNS서버 설치</a></li><li><a href="/cloudpak/cp4app/install/infra05.html" class="sidebar-link">Infra Servers-HAProxy서버 설치</a></li><li><a href="/cloudpak/cp4app/install/infra06.html" class="sidebar-link">Infra Servers-DHCP서버 설치</a></li><li><a href="/cloudpak/cp4app/install/infra07.html" class="sidebar-link">Infra Servers-NFS서버 설치</a></li><li><a href="/cloudpak/cp4app/install/infra08.html" class="sidebar-link">Infra Servers-SSLKey 구성</a></li><li><a href="/cloudpak/cp4app/install/infra09.html" class="sidebar-link">Infra Servers-iptables 설치</a></li><li><a href="/cloudpak/cp4app/install/ocp01.html" class="sidebar-link">OCP-ignition파일 및 VM생성</a></li><li><a href="/cloudpak/cp4app/install/ocp02.html" class="sidebar-link">OCP-OCP설치</a></li><li><a href="/cloudpak/cp4app/install/ocp03.html" class="sidebar-link">OCP-Local Image Registry 구성</a></li><li><a href="/cloudpak/cp4app/install/ocp04.html" class="sidebar-link">OCP-NFS Dynamic provisioning</a></li><li><a href="/cloudpak/cp4app/install/ocp05.html" class="sidebar-link">OCP-IdP 추가</a></li><li><a href="/cloudpak/cp4app/install/cp4app01.html" class="active sidebar-link">CP4App-Common Service 설치</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cloudpak/cp4app/install/cp4app01.html#ldap서버-설치-및-user-group추가" class="sidebar-link">LDAP서버 설치 및 user/group추가</a></li><li class="sidebar-sub-header"><a href="/cloudpak/cp4app/install/cp4app01.html#ibm-common-service-설치" class="sidebar-link">IBM Common Service 설치</a></li><li class="sidebar-sub-header"><a href="/cloudpak/cp4app/install/cp4app01.html#ibm-common-service-설정" class="sidebar-link">IBM Common Service 설정</a></li><li class="sidebar-sub-header"><a href="/cloudpak/cp4app/install/cp4app01.html#ocp-ocp-idp로-등록" class="sidebar-link">OCP-OCP IdP로 등록</a></li><li class="sidebar-sub-header"><a href="/cloudpak/cp4app/install/cp4app01.html#logout-버그-fix" class="sidebar-link">Logout 버그 Fix</a></li></ul></li><li><a href="/cloudpak/cp4app/install/cp4app02.html" class="sidebar-link">CP4App-CP4App 설치</a></li></ul></section></li></ul></section></li><li><a href="/cloudpak/cp4mm/overview.html" class="sidebar-link">CP4MM</a></li><li><a href="/cloudpak/md-sample.html" class="sidebar-link">Markdown sample</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="cp4app-common-service-설치"><a href="#cp4app-common-service-설치" class="header-anchor">#</a> CP4App-Common Service 설치</h1> <div class="custom-block tip"><p class="custom-block-title">TASK DESCRIPTION</p> <p>IBM Common Service를 설치합니다.<br>
Common Service는 IAM, Metering, Monitoring을 제공합니다.<br>
IBM Common Service설치 가이드는 아래와 같이 볼 수 있습니다.</p> <ul><li><a href="https://www.ibm.com/support/knowledgecenter/en/SSCSJL/welcome.html" target="_blank" rel="noopener noreferrer">CP4App knowledge center<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>접근</li> <li>설치할 버전 선택</li> <li>Installing &gt; Installing with the cloud pak CLI &gt; Installing Common Services 클릭<br> <img src="/assets/img/2020-05-26-16-52-38.af4bb723.png" alt=""></li></ul> <p>IBM Common Service IAM에 대한 설명, 설치, 구성에 대해서는 아래 동영상을 참조하십시오.<br> <a href="https://drive.google.com/file/d/1seMcwdapR2tf9lJSkp-jsBGogG86elyw/view?usp=sharing" target="_blank" rel="noopener noreferrer">IBM Common Service IAM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p></p><div class="table-of-contents"><ul><li><a href="#ldap서버-설치-및-user-group추가">LDAP서버 설치 및 user/group추가</a></li><li><a href="#ibm-common-service-설치">IBM Common Service 설치</a><ul><li><a href="#설치registry를-접근하기-위한-entitlement-key취득">설치registry를 접근하기 위한 entitlement key취득</a></li><li><a href="#설치-configuration-files-생성">설치 configuration files 생성</a></li><li><a href="#snapshot-작성">snapshot 작성</a></li><li><a href="#설치-config파일들-수정">설치 config파일들 수정</a></li><li><a href="#installer-실행">installer 실행</a></li><li><a href="#common-service-로그인">Common Service 로그인</a></li></ul></li><li><a href="#ibm-common-service-설정">IBM Common Service 설정</a></li><li><a href="#ocp-ocp-idp로-등록">OCP-OCP IdP로 등록</a></li><li><a href="#logout-버그-fix">Logout 버그 Fix</a></li></ul></div><p></p></div> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>설치 시 <a href="https://happycloud-lee.tistory.com/119" target="_blank" rel="noopener noreferrer">screen: 가상터미널을 이용한 백그라운드 명령 실행<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>을 이용하여 보십시오.<br>
실수나 네트워크 단절로 Terminal이 끊어져도 안전하게 설치를 진행할 수 있습니다.</p></div> <p>아래 작업은 Cluster api-server에 접근할 수 있는 Terminal 또는 bastion서버에서 수행합니다.</p> <h2 id="ldap서버-설치-및-user-group추가"><a href="#ldap서버-설치-및-user-group추가" class="header-anchor">#</a> LDAP서버 설치 및 user/group추가</h2> <p>IBM Common Service의 IAM은 IdP(Identity Provider)로 LDAP만 지원합니다.</p> <ul><li><strong>아래 글을 참조하여 LDAP서버를 docker 또는 Pod로 설치합니다.</strong></li></ul> <p><a href="https://happycloud-lee.tistory.com/117?category=832250" target="_blank" rel="noopener noreferrer">LDAP서버 설치<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <img src="/assets/img/2020-05-26-16-58-51.c8b10d1e.png" alt=""></p> <ul><li><p><strong>LDAP user/group추가</strong></p> <ul><li><strong>ou=users, ou=groups추가</strong><br>
Generic: Organizational Unit 선택<br> <img src="/assets/img/2020-05-26-17-33-02.0a7fc9fd.png" alt=""></li></ul> <p>users 또는 groups입력<br> <img src="/assets/img/2020-05-26-17-35-16.90442847.png" alt=""></p> <p>[Commit]클릭<br> <img src="/assets/img/2020-05-26-17-35-46.41d49a81.png" alt=""></p> <ul><li><strong>user추가</strong><br>
ou=users선택 &gt; Create a child entry 클릭<br> <img src="/assets/img/2020-05-26-17-37-23.de5218ec.png" alt="">
'Default'선택<br> <img src="/assets/img/2020-05-26-17-38-31.446dffe3.png" alt="">
'iNetOrgPerson'선택<br> <img src="/assets/img/2020-05-26-17-39-23.2b0c6955.png" alt="">
RDN은 'Usern Name(uid)'선택. cn, sn, password, username입력<br> <img src="/assets/img/2020-05-26-17-41-34.368ebb40.png" alt="">
[Commit]클릭<br> <img src="/assets/img/2020-05-26-17-42-19.af19d841.png" alt=""></li></ul> <p>다른 사용자 추가시에는 기존 user를 복사하여 생성하는게 편함<br> <img src="/assets/img/2020-05-26-17-46-50.7cb14922.png" alt=""> <img src="/assets/img/2020-05-26-17-47-24.de935a94.png" alt=""> <img src="/assets/img/2020-05-26-17-47-56.82ae6f10.png" alt=""></p> <ul><li><strong>group추가</strong><br>
ou=groups선택 &gt; Create a child entry 클릭<br> <img src="/assets/img/2020-05-26-17-48-29.2e906acc.png" alt="">
'Default'선택<br> <img src="/assets/img/2020-05-26-17-49-12.6e52938f.png" alt="">
'groupOfUniqueNames'선택<br> <img src="/assets/img/2020-05-26-17-49-44.2e1536cb.png" alt="">
RDN은 'cn(cn)'선택. cn, uniqueMember선택<br> <img src="/assets/img/2020-05-26-17-50-46.11e108cb.png" alt="">
[Commit]클릭<br> <img src="/assets/img/2020-05-26-17-51-41.d9184816.png" alt="">
다른 그룹 추가시에는 user복사와 유사하게 'Copy or move this entry'를 클릭하여 기존 group을 복사하여 생성하면 됨<br> <img src="/assets/img/2020-05-26-17-52-48.64af993e.png" alt=""></li></ul></li></ul> <h2 id="ibm-common-service-설치"><a href="#ibm-common-service-설치" class="header-anchor">#</a> IBM Common Service 설치</h2> <h3 id="설치registry를-접근하기-위한-entitlement-key취득"><a href="#설치registry를-접근하기-위한-entitlement-key취득" class="header-anchor">#</a> 설치registry를 접근하기 위한 entitlement key취득</h3> <ul><li><strong>Installing &gt; Installing with the cloud pak CLI클릭</strong><br> <img src="/assets/img/2020-05-26-17-57-40.0f90e384.png" alt=""></li> <li><strong>MyIBM Container Software library클릭</strong><br> <a href="https://myibm.ibm.com/products-services/containerlibrary" target="_blank" rel="noopener noreferrer">MyIBM Container Software library<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <img src="/assets/img/2020-05-26-17-56-29.9d42c038.png" alt=""></li> <li><strong>Login</strong><br> <img src="/assets/img/2020-05-26-18-02-39.def05f21.png" alt=""></li> <li><strong>Key값 복사</strong><br> <img src="/assets/img/2020-05-26-18-04-00.dc4b8e85.png" alt=""></li></ul> <h3 id="설치-configuration-files-생성"><a href="#설치-configuration-files-생성" class="header-anchor">#</a> 설치 configuration files 생성</h3> <ul><li><strong>환경변수값 셋팅</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>&lt;apikey&gt;에는 위에서 복사한 key값을 입력하면 됨  
$ export ENTITLED_REGISTRY=cp.icr.io
$ export ENTITLED_REGISTRY_USER=cp
$ export ENTITLED_REGISTRY_KEY=&lt;apikey&gt;
</code></pre></div><ul><li><strong>registry login</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ docker login &quot;$ENTITLED_REGISTRY&quot; -u &quot;$ENTITLED_REGISTRY_USER&quot; -p &quot;$ENTITLED_REGISTRY_KEY&quot;
</code></pre></div><ul><li><strong>container image을 pulling하고 라이센스 보기</strong><br>
'icpa-installer:4.1.1'는 설치 버전에 맞게 변경하십시오.</li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ docker run -e LICENSE=view \
           &quot;$ENTITLED_REGISTRY/cp/icpa/icpa-installer:4.1.1&quot;
</code></pre></div><p><img src="/assets/img/2020-05-26-20-31-29.09aea278.png" alt=""> <img src="/assets/img/2020-05-26-20-32-15.73f7678d.png" alt=""></p> <blockquote><p><strong>※ bastion VM에 docker 설치</strong><br> <a href="https://happycloud-lee.tistory.com/14?category=830565" target="_blank" rel="noopener noreferrer">docker설치<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>를 참조하여 설치하십시오.</p></blockquote> <ul><li><strong>설치 config파일들 생성</strong><br>
'icpa-installer:4.1.1'는 설치 버전에 맞게 변경하십시오.</li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ mkdir ~/data
$ docker run -v $PWD/data:/data:z -u 0 \
           -e LICENSE=accept \
           &quot;$ENTITLED_REGISTRY/cp/icpa/icpa-installer:4.1.1&quot; cp -r &quot;data/*&quot; /data
</code></pre></div><p><img src="/assets/img/2020-05-26-20-32-52.f0b868d7.png" alt=""></p> <h3 id="snapshot-작성"><a href="#snapshot-작성" class="header-anchor">#</a> snapshot 작성</h3> <p>Common Service 설치 전에 모든 VM들의 snapshot을 작성합니다.</p> <h3 id="설치-config파일들-수정"><a href="#설치-config파일들-수정" class="header-anchor">#</a> 설치 config파일들 수정</h3> <ul><li><p><strong>Installing &gt; Installing with the cloud pak CLI &gt; Installing Common Services 클릭</strong><br> <img src="/assets/img/2020-05-26-16-52-38.af4bb723.png" alt=""></p></li> <li><p><strong>commonservice.yaml 수정</strong><br>
storageClass, dedicatedNodes, services를 수정합니다.<br> <img src="/assets/img/2020-05-26-20-54-57.4b79774f.png" alt=""></p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>SAMPLE

...
spec:
  ...
  storageClass: thin
  ...
  dedicatedNodes:
    - worker-1.hcis.kubepia.com 
    - worker-2.hcis.kubepia.com
    - worker-3.hcis.kubepia.com
  ...

</code></pre></div><ul><li>storageClass: 'thin'으로 지정<br>
Provisioner가 'kubernetes.io/no-provisioner'가 아니고 accessMode가 ReadWriteOnce인 Storage Class지정</li> <li>dedicatedNodes: common service가 설치될 Worker Node들 지정.<br>
HA를 위해 1개 이상의 홀수로 지정하여야 함</li> <li>services: 설치할 service는 present로 변경.</li></ul> <h3 id="installer-실행"><a href="#installer-실행" class="header-anchor">#</a> installer 실행</h3> <ul><li><strong>cluster login</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ oc login https://&lt;your_cluster_hostname&gt; -u &lt;username&gt; -p &lt;password&gt;
</code></pre></div><p><img src="/assets/img/2020-05-26-21-07-34.6907198f.png" alt=""></p> <ul><li><strong>installer 실행</strong><br>
'icpa-installer:4.1.1'는 설치 버전에 맞게 변경하십시오.</li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ docker run -v ~/.kube:/root/.kube:z -u 0 -t \
          -v $PWD/data:/installer/data:z \
          -e LICENSE=accept \
          -e ENTITLED_REGISTRY -e ENTITLED_REGISTRY_USER -e ENTITLED_REGISTRY_KEY \
          &quot;$ENTITLED_REGISTRY/cp/icpa/icpa-installer:4.1.1 cs-install
</code></pre></div><h3 id="common-service-로그인"><a href="#common-service-로그인" class="header-anchor">#</a> Common Service 로그인</h3> <ul><li><strong>install 완료 확인</strong><br>
완료 메시지에서 common service url, default admin id, default admin password를 구합니다.<br> <img src="/assets/img/2020-05-26-21-13-17.d9d95836.png" alt=""></li></ul> <div class="language- extra-class"><pre class="language-text"><code>default admin id : csadmin
$ oc -n ibmplatform-service get secret admin-credential -o jsonpath='{.data.defaultAdminUser}' | base64 --decode

default admin pw
$ oc -n ibmplatform-service get secret admin-credential -o jsonpath='{.data.defaultAdminPassword}' | base64 --decode
</code></pre></div><ul><li><strong>Common Service 로그인</strong><br>
위에서 구한 url로 접근하고, admin id/pw로 로그인합니다.<br> <img src="/assets/img/2020-05-26-21-18-15.58dede26.png" alt=""> <img src="/assets/img/2020-05-26-21-18-44.75d0ccf0.png" alt=""></li></ul> <h2 id="ibm-common-service-설정"><a href="#ibm-common-service-설정" class="header-anchor">#</a> IBM Common Service 설정</h2> <ul><li><strong>LDAP Connection 추가</strong></li></ul> <table><thead><tr><th style="text-align:left;">항목</th> <th style="text-align:left;">설명</th> <th style="text-align:left;">예</th></tr></thead> <tbody><tr><td style="text-align:left;">connection name</td> <td style="text-align:left;">적절하게 구별된 이름 부여</td> <td style="text-align:left;">seromi-ldap</td></tr> <tr><td style="text-align:left;">Server type</td> <td style="text-align:left;">LDAP 종류. openldap은 Custom선택</td> <td style="text-align:left;">Custom</td></tr> <tr><td style="text-align:left;">Base DN</td> <td style="text-align:left;">LDAP Hostname에 따라 구별된 이름 지정</td> <td style="text-align:left;">dc=ldap,dc=cp,dc=darumtech,dc=net</td></tr> <tr><td style="text-align:left;">Bind DN</td> <td style="text-align:left;">LDAP admin의 구별된 이름 지정</td> <td style="text-align:left;">cn=admin,dc=ldap,dc=cp,dc=darumtech,dc=net</td></tr> <tr><td style="text-align:left;">Bind DN password</td> <td style="text-align:left;">LDAP admin 암호</td> <td style="text-align:left;">생략</td></tr> <tr><td style="text-align:left;">Group filter</td> <td style="text-align:left;">Group가져올때 query</td> <td style="text-align:left;">(&amp;(cn=%v)(objectclass=groupOfUniqueNames))</td></tr> <tr><td style="text-align:left;">User filter</td> <td style="text-align:left;">User가져올때 query</td> <td style="text-align:left;">(&amp;(uid=%v)(objectclass=inetOrgPerson))</td></tr></tbody></table> <p><img src="/assets/img/2020-05-26-21-25-09.e9156a8b.png" alt=""> <img src="/assets/img/2020-05-26-21-34-29.6acbd18a.png" alt=""></p> <ul><li><p><strong>Team 추가</strong></p> <ul><li><p>Teams탭을 클릭하고 [Create Team]클릭<br> <img src="/assets/img/2020-05-26-21-37-43.412c6da3.png" alt=""></p></li> <li><p>Member로 LDAP user/group지정<br> <img src="/assets/img/2020-05-26-21-38-49.cced4701.png" alt=""> <img src="/assets/img/2020-05-26-21-39-57.22d1cc7e.png" alt=""></p></li></ul></li> <li><p><strong>Namespace 권한 부여</strong></p> <ul><li><p>권한을 부여할 Team을 클릭합니다.<br> <img src="/assets/img/2020-05-26-21-45-03.09d69133.png" alt=""></p></li> <li><p>Resources탭을 클릭하고 [Manage resource]를 클릭합니다.<br> <img src="/assets/img/2020-05-26-21-41-30.85e50e79.png" alt=""></p></li> <li><p>권한부여할 namespace들을 체크합니다.<br> <img src="/assets/img/2020-05-26-21-45-58.0fda5e55.png" alt=""></p></li></ul></li></ul> <h2 id="ocp-ocp-idp로-등록"><a href="#ocp-ocp-idp로-등록" class="header-anchor">#</a> OCP-OCP IdP로 등록</h2> <p>OCP의 IdP로 Common Service를 등록합니다.</p> <ul><li><p><strong>IdP등록 가이드 오픈</strong><br>
설치 가이드에서 '
Setting up IBM Common IAM as OpenShift OAuth Identity Provider'을 클릭합니다.<br> <img src="/assets/img/2020-05-26-21-58-38.1bd14e91.png" alt=""></p></li> <li><p><strong>Common IAM의 admin id/pw를 구합니다.</strong></p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ oc -n ibmplatform-service get secret admin-credential -o jsonpath='{.data.defaultAdminUser}' | base64 --decode

$ oc -n ibmplatform-service get secret admin-credential -o jsonpath='{.data.defaultAdminPassword}' | base64 --decode
</code></pre></div><ul><li><strong>Common Service dashboard URL을 구합니다.</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ oc -n kube-system get route icp-console -o=jsonpath={.spec.host}
</code></pre></div><ul><li><strong>Common Service CA(Certificate Authority) File생성</strong><br>
아래 명령으로 icp-console.pem파일을 생성합니다.</li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ oc -n kube-system get secret icp-management-ingress-tls-secret -o=jsonpath='{.data.tls\.crt}' | base64 --decode | tee -a icp-console.pem
</code></pre></div><ul><li><strong>Client 리소스 생성</strong><br> <strong>openclient.yaml생성</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ vi openclient.yaml 

apiVersion: oidc.security.ibm.com/v1
kind: Client
metadata:
  namespace: default
  name: ocpclient
spec:
  secret: ocpclientsecret
  oidcLibertyClient:
    post_logout_redirect_uris:
    - https://console-openshift-console.apps.example.com:443
    trusted_uri_prefixes:
    - https://console-openshift-console.apps.example.com:443
    redirect_uris:
    - https://oauth-openshift.apps.example.com/oauth2callback/IBM-IAM
</code></pre></div><p><strong>'oidcLibertyClient' 하위의 주소 3개를 변경합니다.</strong><br> <img src="/assets/img/2020-05-26-22-13-04.1b1a0d70.png" alt=""></p> <p><strong>Client 리소스 생성</strong><br>
$ oc apply -f openclient.yaml</p> <p><strong>리소스 생성 확인</strong></p> <div class="language- extra-class"><pre class="language-text"><code>$ oc get Client ocpclient -n default
</code></pre></div><ul><li><strong>CLIENT_ID와 CLIENT_SECRET값을 구합니다.</strong></li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ oc -n default get secret ocpclientsecret -o jsonpath='{.data.CLIENT_ID}' | base64 --decode
$ oc -n default get secret ocpclientsecret -o jsonpath='{.data.CLIENT_SECRET}' | base64 --decode
</code></pre></div><ul><li><strong>OCP OAuth페이지 오픈</strong><br>
cluster-admin역할을 가진 사용자(예:kubeadmin)로 로그인합니다.<br>
Administration &gt; Cluster Settings을 선택 후 Global Configuration탭을 누릅니다.<br> <img src="/assets/img/2020-05-26-22-18-16.64b42743.png" alt=""></li></ul> <p>OAuth를 찾아 클릭합니다.<br> <img src="/assets/img/2020-05-26-22-19-00.4fe686b9.png" alt=""></p> <ul><li><p><strong>IdP추가</strong></p> <ul><li>Identity Providers에서 [Add]클릭하고, OpenID Connect를 선택합니다.<br> <img src="/assets/img/2020-05-26-22-20-03.16144bc0.png" alt=""></li> <li>Name, Client ID, Client Secret, Issuer URL을 입력합니다.<br> <strong>Name은 반드시 'IBM-IAM'으로 해야 합니다.</strong><br> <strong>Issuer URL은 [Common Services dashboard URL]/oidc/endpoint/OP입니다.</strong><br> <img src="/assets/img/2020-05-26-22-23-30.593a0523.png" alt=""></li> <li>CA File, Extra Scopes를 입력합니다.<br> <strong>Extra Scopes의 값은 반드시 'profile'로 해야 합니다.</strong><br> <img src="/assets/img/2020-05-26-22-27-18.42e7f681.png" alt=""></li></ul></li> <li><p><strong>Common Service로 로그인</strong><br>
Logout을 하면 로그인페이지에 IBM-IAM이라는 버튼이 표시됩니다.<br> <img src="/assets/img/2020-05-26-22-31-47.5adb2607.png" alt=""></p></li></ul> <p>IBM-IAM을 클릭하면 Common Service Login페이지가 표시됩니다.<br> <img src="/assets/img/2020-05-26-22-33-12.5496c58a.png" alt=""></p> <p>로그인이 정상적으로 되면 OCP 초기화면이 표시됩니다.<br> <img src="/assets/img/2020-05-26-22-33-57.820ac53f.png" alt=""></p> <h2 id="logout-버그-fix"><a href="#logout-버그-fix" class="header-anchor">#</a> Logout 버그 Fix</h2> <p>IBM Common Service로 로그인을 하면 Logout이 안되는 버그가 있습니다.<br> <a href="https://happycloud-lee.tistory.com/118" target="_blank" rel="noopener noreferrer">IBM CommonService IAM 로그아웃 안되는 현상 해결<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>문서를 참조하여 처리하십시오.</p> <hr> <p><strong>중요: User Identities 초기화</strong></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>각 사용자는 인증 IdP에 따라 Identities값이 셋팅됩니다.<br>
IdP가 변경된다면(예: htpasswd =&gt; Common Service IAM) Identities값을 초기화해줘야 합니다.<br>
예를 들어 user1이 htpasswd로 등록되었다가 Common Service의 LDAP에 등록된 경우<br>
만약 user1이 htpasswd로 로그인했다면 Identities는 'htpasswd-user1'이 됩니다.<br>
user1을 LDAP에 등록 후 Common Service로 로그인하려고 하면<br>
'사용자를 생성할 수 없다'라는 에러가 납니다.</p> <p><strong>Identities값 초기화는 YAML을 편집하여 identities의 값을 'null'로 변경하면 됩니다.</strong></p> <p><img src="/assets/img/2020-05-26-22-45-24.19c85e93.png" alt=""></p></div> <hr> <div id="disqus_thread"></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/cloudpak/cp4app/install/ocp05.html" class="prev">
        OCP-IdP 추가
      </a></span> <span class="next"><a href="/cloudpak/cp4app/install/cp4app02.html">
        CP4App-CP4App 설치
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.3d45536c.js" defer></script><script src="/assets/js/2.3853ba78.js" defer></script><script src="/assets/js/3.8474c116.js" defer></script><script src="/assets/js/22.f96cd654.js" defer></script>
  </body>
</html>
